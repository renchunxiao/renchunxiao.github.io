<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Java，JVM，Redis，Hbase，分布式，Mongo"><title>tomcat 数据库连接池之 ConnectionPool 上 | 任春晓的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">tomcat 数据库连接池之 ConnectionPool 上</h1><a id="logo" href="/.">任春晓的博客</a><p class="description">学而不思则罔，思而不学则殆</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">tomcat 数据库连接池之 ConnectionPool 上</h1><div class="post-meta">Aug 27, 2015<span> | </span><span class="category"><a href="/categories/数据库连接池/">数据库连接池</a></span></div><div class="post-content"><h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><blockquote>
<p>数据库连接是一种关键的有限的昂贵的资源，这一点在多用户的网页应用程序中体现得尤为突出。对数据库连接的管理能显著影响到整个应用程序的伸缩性和健壮性，影响到程序的性能指标。数据库连接池正是针对这个问题提出来的。数据库连接池负责分配、管理和释放数据库连接，它允许应用程序重复使用一个现有的数据库连接，而不是再重新建立一个；释放空闲时间超过最大空闲时间的数据库连接来避免因为没有释放数据库连接而引起的数据库连接遗漏。这项技术能明显提高对数据库操作的性能。</p>
</blockquote>
<h2 id="Tomcat-jdbc-pool"><a href="#Tomcat-jdbc-pool" class="headerlink" title="Tomcat jdbc pool"></a>Tomcat jdbc pool</h2><p>Tomcat 在 7.0 以前的版本都是使用 commons-dbcp 做为连接池的实现，但是目前都切换到 Tomcat jdbc pool 了。具体的看下面的介绍：</p>
<p><a href="http://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html</a></p>
<h3 id="ConnectionPool"><a href="#ConnectionPool" class="headerlink" title="ConnectionPool"></a>ConnectionPool</h3><p>首先我们来分析下，最基本的连接池会提供什么样的功能，并且以什么样的数据结构出现。</p>
<p>连接池首先应该提供的主要功能：</p>
<ul>
<li>获取连接</li>
<li>释放连接：真实关闭连接</li>
<li>返回连接：将使用完的连接放回到池</li>
</ul>
<p>连接池的数据结构：</p>
<ul>
<li>连接容器：存放提前创建的连接</li>
</ul>
<p>上面是一个连接池框架应该提供的最基本的功能，那么看一下 tomcat jdbc pool 是如何实现的。首先是看下 ConnectionPool 内部的数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用阻塞队列来存放已经在使用的连接</span></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;PooledConnection&gt; busy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用阻塞队列来存放空闲的连接</span></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;PooledConnection&gt; idle;</span><br></pre></td></tr></table></figure>
<p>具体的执行是，我们从 idle 当中获取连接，如果有那么把这个连接放到 busy 当中。当返回连接的时候是一个反过来的流程。</p>
<p>当 idle 当中没有空闲连接的时候，会去判断，如果没达到最大连接数就去创建新的连接，如果到达了就等待，超过等待时间就超时。</p>
<h3 id="初始化-ConnectionPool"><a href="#初始化-ConnectionPool" class="headerlink" title="初始化 ConnectionPool"></a>初始化 ConnectionPool</h3><p>再来看下 ConnectionPool 的初始化过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConnectionPool</span><span class="params">(PoolConfiguration prop)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">//setup quick access variables and pools</span></span><br><span class="line">        init(prop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(PoolConfiguration properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        poolProperties = properties;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...省略代码</span></span><br><span class="line"></span><br><span class="line">        busy = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (properties.isFairQueue()) <span class="comment">// 如果是公平的创建的阻塞队列不一样</span></span><br><span class="line">            idle = <span class="keyword">new</span> FairBlockingQueue&lt;&gt;();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            idle = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initializePoolCleaner(properties);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//...省略代码</span></span><br><span class="line"></span><br><span class="line">        PooledConnection[] initialPool = <span class="keyword">new</span> PooledConnection[poolProperties.getInitialSize()];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initialPool.length; i++) &#123;<span class="comment">//循环创建连接</span></span><br><span class="line">                initialPool[i] = <span class="keyword">this</span>.borrowConnection(<span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException x) &#123;</span><br><span class="line">            log.error(<span class="string">"Unable to create initial connections of pool."</span>, x);</span><br><span class="line">            <span class="comment">//...省略代码</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initialPool.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initialPool[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;<span class="keyword">this</span>.returnConnection(initialPool[i]);&#125;<span class="keyword">catch</span>(Exception x)&#123;<span class="comment">/*NOOP*/</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面 init 方法省略了部分代码，主要就是 borrowConnection 和 returnConnection 两个方法。</p>
<p>先循环创建 N 个连接，并且放到了 busy 的队列中，然后在 finally 当中归还连接，这样就初始化了 N 个闲置的连接了。</p>
<ul>
<li>borrowConnection：借连接，如果没连接的话会去创建一个，还会有一些其他的判断</li>
<li>returnConnection：返还连接，里面也会判断是否需要真实关闭的情况</li>
</ul>
<p>再来看 borrowConnection 代码的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wait 参数，等待连接的时间，如果传入的是0，那么不等待。如果传入的是-1，那么使用配置的 maxWait。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">borrowConnection</span><span class="params">(<span class="keyword">int</span> wait, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isClosed()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Connection pool closed."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        PooledConnection con = idle.poll();<span class="comment">//先从空闲队列当中获取一个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (con!=<span class="keyword">null</span>) &#123;<span class="comment">//空闲队列当中有空闲连接</span></span><br><span class="line">                PooledConnection result = borrowConnection(now, con, username, password);</span><br><span class="line">                <span class="comment">//null should never be returned, but was in a previous impl.</span></span><br><span class="line">                <span class="keyword">if</span> (result!=<span class="keyword">null</span>) <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (size.get() &lt; getPoolProperties().getMaxActive()) &#123;<span class="comment">// 判断 size 是不是小于最大的活跃连接数</span></span><br><span class="line">                <span class="keyword">if</span> (size.addAndGet(<span class="number">1</span>) &gt; getPoolProperties().getMaxActive()) &#123;<span class="comment">// 如果自增完大于最大活跃数，则不能创建连接</span></span><br><span class="line">                    size.decrementAndGet();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> createConnection(now, con, username, password);<span class="comment">//创建新连接</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> maxWait = wait;</span><br><span class="line">            <span class="keyword">if</span> (wait==-<span class="number">1</span>) &#123;</span><br><span class="line">                maxWait = (getPoolProperties().getMaxWait()&lt;=<span class="number">0</span>)?Long.MAX_VALUE:getPoolProperties().getMaxWait();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> timetowait = Math.max(<span class="number">0</span>, maxWait - (System.currentTimeMillis() - now));</span><br><span class="line">            waitcount.incrementAndGet();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                con = idle.poll(timetowait, TimeUnit.MILLISECONDS);<span class="comment">//通过传递超时时间来获取连接</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getPoolProperties().getPropagateInterruptState()) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                SQLException sx = <span class="keyword">new</span> SQLException(<span class="string">"Pool wait interrupted."</span>);</span><br><span class="line">                sx.initCause(ex);</span><br><span class="line">                <span class="keyword">throw</span> sx;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                waitcount.decrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (maxWait==<span class="number">0</span> &amp;&amp; con == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (jmxPool!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                    jmxPool.notify(org.apache.tomcat.jdbc.pool.jmx.ConnectionPool.POOL_EMPTY, <span class="string">"Pool empty - no wait."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PoolExhaustedException(<span class="string">"["</span> + Thread.currentThread().getName()+<span class="string">"] "</span> +</span><br><span class="line">                        <span class="string">"NoWait: Pool empty. Unable to fetch a connection, none available["</span>+busy.size()+<span class="string">" in use]."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (con == <span class="keyword">null</span>) &#123;<span class="comment">//超时没获取到连接</span></span><br><span class="line">                <span class="keyword">if</span> ((System.currentTimeMillis() - now) &gt;= maxWait) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (jmxPool!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                        jmxPool.notify(org.apache.tomcat.jdbc.pool.jmx.ConnectionPool.POOL_EMPTY, <span class="string">"Pool empty - timeout."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PoolExhaustedException(<span class="string">"["</span> + Thread.currentThread().getName()+<span class="string">"] "</span> +</span><br><span class="line">                        <span class="string">"Timeout: Pool empty. Unable to fetch a connection in "</span> + (maxWait / <span class="number">1000</span>) +</span><br><span class="line">                        <span class="string">" seconds, none available[size:"</span>+size.get() +<span class="string">"; busy:"</span>+busy.size()+<span class="string">"; idle:"</span>+idle.size()+<span class="string">"; lastwait:"</span>+timetowait+<span class="string">"]."</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//no timeout, lets try again</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">//while</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面代码看着很长，其实逻辑很简单：</p>
<ul>
<li>先从空闲队列当中获取连接<ul>
<li>如果获取到了：返回</li>
<li>没获取到连接：判断是不是需要新创建连接。<ul>
<li>如果不能新创建：设置超时时间，如果获取到返回，没获取到抛出异常</li>
<li>可以创建：创建新连接，并且返回</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>当然上面的代码当中还有几个问题我们没弄明白：</p>
<ul>
<li>createConnection 会如何创建真实的新连接</li>
<li>当从 idle 队列当中获取到了连接，那么 borrowConnection(now, con, username, password); 会做什么？</li>
</ul>
<p>那么一一分析， createConnection 源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PooledConnection <span class="title">createConnection</span><span class="params">(<span class="keyword">long</span> now, PooledConnection notUsed, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        PooledConnection con = create(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (username!=<span class="keyword">null</span>) con.getAttributes().put(PooledConnection.PROP_USER, username);</span><br><span class="line">        <span class="keyword">if</span> (password!=<span class="keyword">null</span>) con.getAttributes().put(PooledConnection.PROP_PASSWORD, password);</span><br><span class="line">        <span class="keyword">boolean</span> error = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con.lock();</span><br><span class="line">            con.connect();</span><br><span class="line">            <span class="keyword">if</span> (con.validate(PooledConnection.VALIDATE_INIT)) &#123;</span><br><span class="line">                con.setTimestamp(now);</span><br><span class="line">                <span class="keyword">if</span> (getPoolProperties().isLogAbandoned()) &#123;</span><br><span class="line">                    con.setStackTrace(getThreadDump());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!busy.offer(con)) &#123;<span class="comment">//新创建的连接会加入到 busy 队列当中</span></span><br><span class="line">                    log.debug(<span class="string">"Connection doesn't fit into busy array, connection will not be traceable."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> con;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Validation Query Failed, enable logValidationErrors for more details."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            error = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// .. 省略</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (error ) &#123;</span><br><span class="line">                release(con);</span><br><span class="line">            &#125;</span><br><span class="line">            con.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> PooledConnection <span class="title">create</span><span class="params">(<span class="keyword">boolean</span> incrementCounter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (incrementCounter) size.incrementAndGet();</span><br><span class="line">        PooledConnection con = <span class="keyword">new</span> PooledConnection(getPoolProperties(), <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> con;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PooledConnection 是对 jdbc 原生的 Connection 的包装，具体以后分析。</p>
<p>在分析 borrowConnection 的重载方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PooledConnection <span class="title">borrowConnection</span><span class="params">(<span class="keyword">long</span> now, PooledConnection con, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">// 进入了这个方法代表我们从 idle 队列当中获取到了连接，那么需要对这个连接进行一些设置</span></span><br><span class="line">        <span class="keyword">boolean</span> setToNull = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con.lock();</span><br><span class="line">            <span class="keyword">if</span> (con.isReleased()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//是否需要强制重新连接</span></span><br><span class="line">            <span class="keyword">boolean</span> forceReconnect = con.shouldForceReconnect(username, password) || con.isMaxAgeExpired();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!con.isDiscarded() &amp;&amp; !con.isInitialized()) &#123;</span><br><span class="line">            	<span class="comment">// 连接没被废弃，但是真实的 connection 是 null</span></span><br><span class="line">                forceReconnect = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!forceReconnect) &#123;<span class="comment">//不需要重新连接</span></span><br><span class="line">                <span class="keyword">if</span> ((!con.isDiscarded()) &amp;&amp; con.validate(PooledConnection.VALIDATE_BORROW)) &#123;</span><br><span class="line">                    con.setTimestamp(now);</span><br><span class="line">                    <span class="keyword">if</span> (getPoolProperties().isLogAbandoned()) &#123;</span><br><span class="line">                        con.setStackTrace(getThreadDump());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!busy.offer(con)) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Connection doesn't fit into busy array, connection will not be traceable."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> con;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">                con.reconnect();</span><br><span class="line">                <span class="keyword">int</span> validationMode = getPoolProperties().isTestOnConnect() || getPoolProperties().getInitSQL()!=<span class="keyword">null</span> ?</span><br><span class="line">                    PooledConnection.VALIDATE_INIT :</span><br><span class="line">                    PooledConnection.VALIDATE_BORROW;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (con.validate(validationMode)) &#123;</span><br><span class="line">                    con.setTimestamp(now);</span><br><span class="line">                    <span class="keyword">if</span> (getPoolProperties().isLogAbandoned()) &#123;</span><br><span class="line">                        con.setStackTrace(getThreadDump());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!busy.offer(con)) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Connection doesn't fit into busy array, connection will not be traceable."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> con;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    release(con);</span><br><span class="line">                    setToNull = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Failed to validate a newly established connection."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">                release(con);</span><br><span class="line">                setToNull = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (x <span class="keyword">instanceof</span> SQLException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (SQLException)x;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    SQLException ex  = <span class="keyword">new</span> SQLException(x.getMessage());</span><br><span class="line">                    ex.initCause(x);</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            con.unlock();</span><br><span class="line">            <span class="keyword">if</span> (setToNull) &#123;</span><br><span class="line">                con = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后分析下 returnConnection 返还连接的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">returnConnection</span><span class="params">(PooledConnection con)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isClosed()) &#123;</span><br><span class="line">            release(con);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                con.lock();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (busy.remove(con)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!shouldClose(con,PooledConnection.VALIDATE_RETURN)) &#123;<span class="comment">//判断当前连接是否需要真实关闭</span></span><br><span class="line">                        con.setStackTrace(<span class="keyword">null</span>);</span><br><span class="line">                        con.setTimestamp(System.currentTimeMillis());</span><br><span class="line">                        <span class="keyword">if</span> (((idle.size()&gt;=poolProperties.getMaxIdle()) &amp;&amp; !poolProperties.isPoolSweeperEnabled()) ||</span><br><span class="line">                         (!idle.offer(con))) &#123;<span class="comment">// 判断空闲队列大于最大空闲数量，或者添加到空闲队列失败，会释放这个连接</span></span><br><span class="line">                            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                                log.debug(<span class="string">"Connection ["</span>+con+<span class="string">"] will be closed and not returned to the pool,</span></span><br><span class="line"><span class="string">                                idle["</span>+idle.size()+<span class="string">"]&gt;=maxIdle["</span>+poolProperties.getMaxIdle()+<span class="string">"] idle.offer failed."</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            release(con);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                            log.debug(<span class="string">"Connection ["</span>+con+<span class="string">"] will be closed and not returned to the pool."</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        release(con);</span><br><span class="line">                    &#125; <span class="comment">//end if</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Connection ["</span>+con+<span class="string">"] will be closed and not returned to the pool, busy.remove failed."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    release(con);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                con.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">//end if</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取连接"><a href="#获取连接" class="headerlink" title="获取连接"></a>获取连接</h3><p>如下源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">//check out a connection</span></span><br><span class="line">        PooledConnection con = borrowConnection(-<span class="number">1</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> setupConnection(con);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Connection <span class="title">setupConnection</span><span class="params">(PooledConnection con)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">//每个连接都有一个代理，获取以前缓存的代理</span></span><br><span class="line">        JdbcInterceptor handler = con.getHandler();</span><br><span class="line">        <span class="keyword">if</span> (handler==<span class="keyword">null</span>) &#123;</span><br><span class="line">            handler = <span class="keyword">new</span> ProxyConnection(<span class="keyword">this</span>,con,getPoolProperties().isUseEquals());</span><br><span class="line">            PoolProperties.InterceptorDefinition[] proxies = getPoolProperties().getJdbcInterceptorsAsArray();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=proxies.length-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    JdbcInterceptor interceptor = proxies[i].getInterceptorClass().newInstance();</span><br><span class="line">                    interceptor.setProperties(proxies[i].getProperties());</span><br><span class="line">                    interceptor.setNext(handler);</span><br><span class="line">                    interceptor.reset(<span class="keyword">this</span>, con);</span><br><span class="line">                    handler = interceptor;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception x) &#123;</span><br><span class="line">                    SQLException sx = <span class="keyword">new</span> SQLException(<span class="string">"Unable to instantiate interceptor chain."</span>);</span><br><span class="line">                    sx.initCause(x);</span><br><span class="line">                    <span class="keyword">throw</span> sx;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            con.setHandler(handler);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            JdbcInterceptor next = handler;</span><br><span class="line">            <span class="keyword">while</span> (next!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                next.reset(<span class="keyword">this</span>, con);</span><br><span class="line">                next = next.getNext();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getProxyConstructor(con.getXAConnection() != <span class="keyword">null</span>);</span><br><span class="line">            Connection connection = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//动态代理，来实现对 PooledConnection 的包装</span></span><br><span class="line">            <span class="keyword">if</span> (getPoolProperties().getUseDisposableConnectionFacade() ) &#123;</span><br><span class="line">                connection = (Connection)proxyClassConstructor.newInstance(<span class="keyword">new</span> Object[] &#123; <span class="keyword">new</span> DisposableConnectionFacade(handler) &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                connection = (Connection)proxyClassConstructor.newInstance(<span class="keyword">new</span> Object[] &#123;handler&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> connection;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            SQLException s = <span class="keyword">new</span> SQLException();</span><br><span class="line">            s.initCause(x);</span><br><span class="line">            <span class="keyword">throw</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>先在 idle 队列当中获取一个空闲的连接，然后包装这个连接。</p>
<p>首先，为什么需要对 PooledConnection 进行包装？因为，我们返回去的连接当这个使用完之后需要关闭的时候，我们不能真正的关闭，需要回收到 idle 队列当中，tomcat jdbc pool 使用了 JDK 的动态代理机制来实现。</p>
<p>本篇结束，下篇继续分析。</p>
<p>—EOF—</p>
</div><div class="tags"><a href="/tags/java-连接池/">java, 连接池</a></div><div class="post-nav"><a class="pre" href="/2015/08/28/tomcat-pool-PooledConnection2/">tomcat 数据库连接池之 ConnectionPool 下</a><a class="next" href="/2015/08/20/lua-metatable/">lua 元表学习</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bootstrap学习/">Bootstrap学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Elasticsearch/">Elasticsearch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java解惑/">Java解惑</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cache/">cache</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/eclipse/">eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/effective-java/">effective-java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/j2ee/">j2ee</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-ognl/">java-ognl</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javaNIO/">javaNIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jms/">jms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js基础/">js基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit/">junit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/log/">log</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/scala/">scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp-ip/">tcp/ip</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/websocket/">websocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码优化/">代码优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式架构/">分布式架构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/">折腾</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库连接池/">数据库连接池</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则表达式/">正则表达式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/理解计算机/">理解计算机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/程序员修炼/">程序员修炼</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/重构/">重构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/页面设计/">页面设计</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">任春晓的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>