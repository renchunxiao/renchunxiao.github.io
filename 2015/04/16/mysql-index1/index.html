<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Java，JVM，Redis，Hbase，分布式，Mongo"><title>mysql 索引学习 上 | 任春晓的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mysql 索引学习 上</h1><a id="logo" href="/.">任春晓的博客</a><p class="description">学而不思则罔，思而不学则殆</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mysql 索引学习 上</h1><div class="post-meta">Apr 16, 2015<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span></div><div class="post-content"><h3 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h3><h4 id="B-TREE-索引"><a href="#B-TREE-索引" class="headerlink" title="B-TREE 索引"></a>B-TREE 索引</h4><p>如下例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> (</span><br><span class="line">	last_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    first_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    dob <span class="built_in">date</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    gender enum(<span class="string">'m'</span>, <span class="string">'f'</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">key</span>(last_name, first_name, dob)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>上面是创建了一个三个字段的联合索引，这个索引对如下类型的查询有效：</p>
<ul>
<li>全值匹配：即三个字段条件都用到</li>
<li>匹配最左前缀：即 last_name = ‘rcx’</li>
<li>匹配列前缀：last_name like ‘A%’</li>
<li>匹配范围值：last_name between ‘Allen’ and ‘Barry’</li>
<li>精确匹配一列范围匹配另外一列：last_name = ‘rcx’ and first_name like ‘L%’</li>
</ul>
<p>B-TREE 索引有如下的一些限制：</p>
<ul>
<li>如果不使用索引最左列查找，无法使用索引。</li>
<li>不能跳过索引中的列，如果指定 last_name = ‘rcx’ and dob = ‘2015-04-01’，则只能使用索引的第一列。</li>
<li>如果查询中某个列有范围查询，那么其右边所有列都无法使用索引优化查询。例如： last_name = ‘rcx’ and first_name like ‘J%’ and dob = ‘2015-01-04’，这个查询只可以用到索引的前两列。</li>
</ul>
<h4 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h4><p>只有 Memory 引擎显示支持哈希索引。</p>
<h3 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h3><p>在 B-TREE 索引中相关的列值也会存储在一起，所以某些查询只使用索引就能够完成全部查询。</p>
<ol>
<li>索引减少了服务器需要扫描的数据量。</li>
<li>索引可以帮助服务器避免排序和临时表。</li>
<li>索引可以将随机 I/O 变为顺序 I/O。</li>
</ol>
<h3 id="索引策略"><a href="#索引策略" class="headerlink" title="索引策略"></a>索引策略</h3><ul>
<li>查询的列不是独立的，则 mysql 无法使用索引。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">id</span> + <span class="number">2</span> = <span class="number">5</span>;//无法使用索引</span><br></pre></td></tr></table></figure>
<ul>
<li>多列索引</li>
</ul>
<p>创建的错误就是为每一列创建索引。</p>
<p>例如，user 表当中在 name 和 age 字段上都单独有一个索引，那么在如下查询的时候会用不到索引(在 mysql 5.0 以前)：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'rcx'</span> <span class="keyword">or</span> age = <span class="number">13</span>;</span><br></pre></td></tr></table></figure>
<p>这个时候 mysql 会优化查询，查询能同时进行单列索引扫描，将结果合并。</p>
<p>当出现索引合并的时候说明索引创建有些问题：</p>
<ul>
<li>当查询出现多个 and 条件的时候，通常意味着需要一个包含所有相关列的索引，而不是多个独立的单列索引。</li>
<li>当条件出现多个 or 的时候，通常会耗费大量 cpu 和内存去进行合并操作。</li>
</ul>
<p>通常这样的情况还不如使用如下 sql ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'rcx'</span> <span class="keyword">union</span> all</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age = <span class="number">13</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>索引顺序</li>
</ul>
<p>在一个多列 B-TREE 索引当中，索引列的顺序意味着索引首先按照最左列进行排序，其次是第二列等。</p>
<p>当不考虑排序和分组的时候，将选择性最高的列放在前面通常的很好的。当然，性能不只是依赖所有索引列的选择性，也和查询条件的具体值有关，也就是和值的分布有关。</p>
<p>看下面的例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age = <span class="number">15</span> <span class="keyword">and</span> sex = <span class="string">'man'</span>;</span><br></pre></td></tr></table></figure>
<p>上面创建索引怎么创建？是(age,sex)还是(sex,age)？这个时候我们可以查询下数据的分布：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(age=<span class="number">15</span>),<span class="keyword">sum</span>(sex=<span class="string">'man'</span>) <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line">7222, 40</span><br></pre></td></tr></table></figure>
<p>这个时候我们创建索引的时候就应该(sex,age)这样，因为 sex=’man’ 条件的数量更小。</p>
<p>当然这样选择索引顺序是依赖特定的数据值的，我们还是需要考虑全局基数和选择性。</p>
<h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>一般情况我们会根据查询的 where 条件来创建合适的索引，不过只是优化一个地方，如果通过索引来获取需要查询的数据，这样就不需要再读取数据行了。</p>
<p>在 mysql 当中只能使用 B-TREE 索引做覆盖索引。</p>
<p>当使用 explain 一个 sql 的时候，当 extra 列的值是 using index 的时候这个就是覆盖索引了。</p>
<p>一般索引无法覆盖有两个原因：</p>
<ul>
<li>没有索引列覆盖到 select 查询的列当中</li>
<li>mysql 不能在索引中执行 like 操作，但是 mysql 能在索引中做最左前缀匹配的 like 查询。</li>
</ul>
<h3 id="使用索引排序"><a href="#使用索引排序" class="headerlink" title="使用索引排序"></a>使用索引排序</h3><p>扫描索引很快，但是如果索引不能覆盖查询到的所有列，就必须要扫描一条索引就查询一次表的行。这基本上都是随机 IO，因此按索引顺序读取数据的速度通常比顺序全表扫描慢。</p>
<p>mysql 可以使用索引即排序又用于查找行。只有当索引的列顺序和 order by 子句的顺序完全一致，并且所有列的排序方向都一样，才可以使用索引对结果排序。如果多表查询，则只有 order by 子句中字段都是第一个表的才能使用索引做排序。</p>
<h3 id="冗余索引"><a href="#冗余索引" class="headerlink" title="冗余索引"></a>冗余索引</h3><p>如果创建了索引 (A, B) 那么再创建索引 (A) 就是冗余索引，但是创建索引 (B) 不是冗余索引，因为它不是索引 (A, B) 的最左前缀列。</p>
<p>【参考资料】</p>
<ol>
<li>[高性能 mysql] (<a href="http://book.douban.com/subject/4241826/" target="_blank" rel="noopener">http://book.douban.com/subject/4241826/</a>)</li>
</ol>
</div><div class="tags"><a href="/tags/mysql/">mysql</a></div><div class="post-nav"><a class="pre" href="/2015/04/17/scala-learn5/">scala 函数式对象</a><a class="next" href="/2015/04/15/mysql-learn1/">mysql 一些知识点补漏</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bootstrap学习/">Bootstrap学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Elasticsearch/">Elasticsearch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java解惑/">Java解惑</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cache/">cache</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/eclipse/">eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/effective-java/">effective-java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/j2ee/">j2ee</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-ognl/">java-ognl</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javaNIO/">javaNIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jms/">jms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js基础/">js基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit/">junit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/log/">log</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/scala/">scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp-ip/">tcp/ip</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/websocket/">websocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码优化/">代码优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式架构/">分布式架构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/思维/">思维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/">折腾</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库连接池/">数据库连接池</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则表达式/">正则表达式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/理解计算机/">理解计算机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/程序员修炼/">程序员修炼</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/重构/">重构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/页面设计/">页面设计</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">任春晓的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>